version: 2.1

# Triggered by GitHub "pull_request merged" event (configured in CircleCI project
# settings under "Triggers"). Runs independently of the push-triggered config.yml,
# so the PRLOG update commit does not re-trigger this workflow.
#
# NOTE: The GitHub "pr merged" event sets both pipeline.git.branch AND
# CIRCLE_BRANCH to the PR's HEAD branch (deleted after merge). The custom
# update-prlog-on-main job switches to main via git checkout and overrides
# CIRCLE_BRANCH=main in $BASH_ENV so pcu operates on the correct branch.
# CircleCI checkout sets the git remote URL to HTTPS. pcu's git2-based push uses
# whatever protocol the remote URL specifies — HTTPS auth (PAT) has no branch
# protection bypass authority. The "Switch remote to SSH" step converts the remote
# URL to SSH so git2 uses the deploy key loaded by add_ssh_keys, which carries the
# GitHub App's bypass authority.
#
# Workflow:
#   update_prlog  - adds merged PR entry to PRLOG.md, commits and pushes to main
#   label         - labels the next queued Renovate PR so it is rebased and runs

parameters:
  fingerprint:
    type: string
    default: SHA256:OkxsH8Z6Iim6WDJBaII9eTT9aaO1f3eDc6IpsgYYPVg
  min-rust-version:
    type: string
    default: "1.87"
  update_pcu:
    type: boolean
    default: true
    description: "If true, pcu is updated from its main github branch before running."

orbs:
  toolkit: jerus-org/circleci-toolkit@4.4.3

jobs:
  update-prlog-on-main:
    # SOURCE: toolkit@4.4.3/jobs/update_prlog
    # ENHANCEMENT: Added "Switch to main branch" step after checkout to handle the
    #   GitHub "pr merged" event, which sets pipeline.git.branch AND CIRCLE_BRANCH
    #   to the PR's HEAD branch (now deleted). pcu reads CIRCLE_BRANCH for its push
    #   target, so git checkout alone is insufficient — CIRCLE_BRANCH must also be
    #   overridden via $BASH_ENV before pcu runs.
    # PLAN: Propose target_branch parameter upstream to toolkit/update_prlog
    executor:
      name: toolkit/rust_env
      min_rust_version: << pipeline.parameters.min-rust-version >>
    steps:
      - checkout
      - run:
          name: Switch to main branch
          command: |
            git fetch origin main
            git checkout main
            echo 'export CIRCLE_BRANCH=main' >> "$BASH_ENV"
      - add_ssh_keys:
          fingerprints:
            - << pipeline.parameters.fingerprint >>
      - run:
          name: Switch remote to SSH
          command: |
            git remote set-url origin \
              "git@github.com:${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}.git"
            echo "Remote URL: $(git remote get-url origin)"
      - run:
          name: Remove original SSH key from agent
          command: |
            ssh-add -l
            if [ -f ~/.ssh/id_rsa.pub ]; then
              ssh-add -d ~/.ssh/id_rsa.pub
            else
              echo "No id_rsa.pub found (GitHub App integration) - skipping removal"
            fi
      - toolkit/gpg_key
      - toolkit/git_config
      - when:
          condition: << pipeline.parameters.update_pcu >>
          steps:
            - toolkit/install_latest_pcu
      - run:
          name: pcu version
          command: pcu --version
      - run:
          name: Update PRLOG or halt
          command: |
            set -e

            # Capture stderr separately so debug logs are visible even when
            # the step halts (successful pipelines don't surface logs otherwise).
            # pcu --push uses the GitHub App API, providing branch protection bypass.
            result=$(pcu -vvv pr --early-exit --push --from-merge \
              2>/tmp/pcu_debug.log) || {
              echo "=== pcu stderr (error) ==="
              cat /tmp/pcu_debug.log
              exit 1
            }

            echo "=== pcu stderr (debug) ==="
            cat /tmp/pcu_debug.log
            echo "=== pcu result: '$result' ==="

            if [ "$result" == "halt" ]; then
              circleci-agent step halt
            fi

workflows:
  update_prlog:
    jobs:
      - update-prlog-on-main:
          context:
            - release
            - bot-check
            - pcu-app
      - toolkit/label:
          min_rust_version: << pipeline.parameters.min-rust-version >>
          context: pcu-app
          requires:
            - update-prlog-on-main
